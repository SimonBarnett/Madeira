<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="login-page">
    <div id="loadingOverlay" style="display: none;">
        <div class="multicircle-loader">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
            <div class="circle circle4"></div>
        </div>
    </div>

    <div class="container" id="loginContainer">
        <h2>Login</h2>
        <div class="custom-login-notice">
            <span class="highlight">Please log in</span> to access your account. If you donâ€™t have an account, click "Sign Up" below.
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <div class="input-container">
                    <input type="email" id="loginEmail" name="email" placeholder="Enter your email" required>
                </div>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <div class="input-container">
                    <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required>
                    <span class="toggle-password"><i class="fas fa-eye"></i></span>
                </div>
            </div>
            <div class="button-container">
                <button type="submit">Login</button>
            </div>
        </form>
        <div class="toggle-link">
            <a href="/signup">Need an account? Sign Up</a><br>
            <a onclick="showForgotPassword()">Forgot Password?</a>
        </div>
    </div>

    <div class="container" id="forgotPasswordContainer" style="display: none;">
        <h2>Forgot Password</h2>
        <form id="forgotPasswordForm">
            <div class="form-group">
                <label for="forgotEmail">Email:</label>
                <input type="email" id="forgotEmail" name="email" placeholder="Enter your email" required>
            </div>
            <button type="submit">Send OTP via SMS</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <div class="container" id="verifyOtpContainer" style="display: none;">
        <h2>Verify OTP</h2>
        <form id="verifyOtpForm">
            <div class="form-group">
                <label for="verifyEmail">Email:</label>
                <input type="email" id="verifyEmail" name="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="otpCode">One-Time Password:</label>
                <input type="text" id="otpCode" name="code" placeholder="Enter the OTP from SMS" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="new_password" placeholder="Enter new password" required>
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" name="confirm_new_password" placeholder="Confirm new password" required>
            </div>
            <button type="submit">Update Password</button>
        </form>
        <div class="toggle-link">
            <a onclick="showLogin()">Back to Login</a>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="/static/js/site-auth.js"></script>
    <script>
        const apiUrl = window.location.origin;

        toastr.options = {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            timeOut: 5000,
            showMethod: 'slideDown',
            hideMethod: 'slideUp'
        };

        function showLoadingOverlay() {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.innerHTML = `
                    <div class="multicircle-loader">
                        <div class="circle circle1"></div>
                        <div class="circle circle2"></div>
                        <div class="circle circle3"></div>
                        <div class="circle circle4"></div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
            console.log('showLoadingOverlay - Overlay displayed');
            return overlay;
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                console.log('hideLoadingOverlay - Overlay hidden');
            }
        }

        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.style.display = 'block';
                document.getElementById('forgotPasswordContainer').style.display = 'none';
                document.getElementById('verifyOtpContainer').style.display = 'none';
                hideLoadingOverlay();
            } else {
                console.error('showLogin - loginContainer not found');
            }
        }

        function showForgotPassword() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'block';
            document.getElementById('verifyOtpContainer').style.display = 'none';
            hideLoadingOverlay();
        }

        function showVerifyOtp(email) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('forgotPasswordContainer').style.display = 'none';
            document.getElementById('verifyOtpContainer').style.display = 'block';
            document.getElementById('verifyEmail').value = email;
            hideLoadingOverlay();
        }

        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });

        async function fetchProtectedPage(url) {
            const token = localStorage.getItem('authToken');
            console.log('fetchProtectedPage - Fetching URL:', `${apiUrl}${url}`);
            console.log('fetchProtectedPage - Token:', token || 'None');

            if (!token) {
                toastr.error('No authentication token found. Please log in.');
                console.error('fetchProtectedPage - No token in localStorage');
                showLogin();
                return;
            }

            const overlay = showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}${url}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'text/html'
                    }
                });

                console.log('fetchProtectedPage - Response Status:', response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('fetchProtectedPage - Response Error:', errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                const html = await response.text();
                console.log('fetchProtectedPage - Received HTML:', html.substring(0, 200));

                document.documentElement.innerHTML = html;

                if (!document.getElementById('loadingOverlay')) {
                    const newOverlay = document.createElement('div');
                    newOverlay.id = 'loadingOverlay';
                    newOverlay.innerHTML = overlay.innerHTML;
                    newOverlay.style.display = 'flex';
                    document.body.prepend(newOverlay);
                    console.log('fetchProtectedPage - Overlay reattached and displayed');
                }

                const head = document.head;
                const requiredStyles = [
                    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css',
                    'https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css',
                    '/static/styles.css'
                ];
                requiredStyles.forEach(href => {
                    if (!head.querySelector(`link[href="${href}"]`)) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = href;
                        head.appendChild(link);
                        console.log(`fetchProtectedPage - Re-added stylesheet: ${href}`);
                    }
                });

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scripts = doc.querySelectorAll('script');
                const scriptPromises = [];
                scripts.forEach(script => {
                    if (script.src) {
                        const newScript = document.createElement('script');
                        newScript.src = script.src;
                        newScript.async = false;
                        scriptPromises.push(
                            new Promise(resolve => {
                                newScript.onload = resolve;
                                newScript.onerror = () => console.error(`fetchProtectedPage - Failed to load script: ${script.src}`);
                                document.head.appendChild(newScript);
                            })
                        );
                        console.log('fetchProtectedPage - Loaded external script:', script.src);
                    } else if (script.innerHTML.trim()) {
                        try {
                            const scriptFn = new Function(script.innerHTML);
                            scriptFn();
                            console.log('fetchProtectedPage - Executed inline script');
                        } catch (e) {
                            console.error('fetchProtectedPage - Error executing inline script:', e);
                        }
                    }
                });

                await Promise.all(scriptPromises);
                setTimeout(() => {
                    const layoutWrapper = document.querySelector('.layout-wrapper');
                    if (layoutWrapper) {
                        layoutWrapper.style.display = 'block';
                        console.log('fetchProtectedPage - Forced .layout-wrapper to display: block');
                    } else {
                        console.error('fetchProtectedPage - .layout-wrapper not found post-fetch');
                        toastr.error('Failed to load page content');
                    }
                    hideLoadingOverlay();
                }, 1000);
            } catch (error) {
                toastr.error(error.message || 'Failed to load protected page');
                console.error('fetchProtectedPage - Fetch Error:', error);
                showLogin();
                hideLoadingOverlay();
            }
        }

        function redirectBasedOnPermissions() {
            const token = localStorage.getItem('authToken');
            console.log('redirectBasedOnPermissions - Checking token:', token || 'None');
            if (!token) return false;

            let decoded;
            try {
                decoded = decodeJWT(token);
            } catch (e) {
                console.error('redirectBasedOnPermissions - Error decoding token:', e);
                toastr.error('Invalid token format. Please log in again.');
                localStorage.removeItem('authToken');
                return false;
            }

            console.log('redirectBasedOnPermissions - Decoded token:', decoded ? JSON.stringify(decoded) : 'null');
            if (!decoded || !decoded.permissions) {
                console.warn('redirectBasedOnPermissions - Invalid or expired token');
                localStorage.removeItem('authToken');
                return false;
            }

            const permissions = decoded.permissions;
            console.log('redirectBasedOnPermissions - Permissions:', permissions);
            let redirectPath;

            if (permissions.includes('admin')) {
                redirectPath = '/admin';
            } else if (permissions.includes('wixpro')) {
                redirectPath = '/partner';
            } else if (permissions.includes('merchant')) {
                redirectPath = '/merchant';
            } else if (permissions.includes('community')) {
                redirectPath = '/community';
            } else {
                console.warn('redirectBasedOnPermissions - No recognized permissions, defaulting to /');
                redirectPath = '/';
            }

            console.log('redirectBasedOnPermissions - Determined redirect path:', redirectPath);
            if (window.location.pathname !== redirectPath) {
                fetchProtectedPage(redirectPath);
                return true;
            }
            return false;
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('loginForm - Origin:', window.location.origin);
            console.log('loginForm - Login URL:', `${apiUrl}/login`);
            console.log('loginForm - Request Payload:', { email, password });

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                console.log('loginForm - Response Status:', response.status);
                if (!response.ok) {
                    const errText = await response.text();
                    console.error('loginForm - Error Response:', errText);
                    let errData;
                    try {
                        errData = JSON.parse(errText);
                    } catch (e) {
                        throw new Error(`Login failed with status ${response.status}: ${errText}`);
                    }
                    throw new Error(errData.message || `Login failed with status ${response.status}`);
                }

                const data = await response.json();
                console.log('loginForm - Response Data:', data);

                if (data.status === 'success') {
                    localStorage.setItem('authToken', data.token);
                    if (data.userId) localStorage.setItem('userId', data.userId);

                    const contactName = data.contact_name || 'User';
                    toastr.success(`Welcome back, ${contactName}!`);
                    redirectBasedOnPermissions();
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                toastr.error(error.message || 'Unable to connect to server.');
                console.error('loginForm - Fetch Error:', error);
                hideLoadingOverlay();
            }
        });

        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value.trim();

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const rawText = await response.text();
                console.log('forgotPasswordForm - Raw Response:', rawText);
                const data = JSON.parse(rawText);

                console.log('forgotPasswordForm - Parsed Response:', data);
                if (!response.ok) {
                    throw new Error(data.message || 'Reset request failed');
                }

                toastr.success('A one-time password has been sent to your phone.');
                showVerifyOtp(email);
            } catch (error) {
                toastr.error(error.message || 'Error sending OTP');
                console.error('forgotPasswordForm - Error:', error);
                hideLoadingOverlay();
            }
        });

        document.getElementById('verifyOtpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('verifyEmail').value.trim();
            const code = document.getElementById('otpCode').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            const passwordRegex = /^(?=.*\d).{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                toastr.error('New password must be at least 8 characters long and include numbers');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                toastr.error('New password and confirmation do not match');
                return;
            }

            showLoadingOverlay();
            try {
                const response = await fetch(`${apiUrl}/verify-reset-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, new_password: newPassword })
                });

                const rawText = await response.text();
                console.log('verifyOtpForm - Raw Response:', rawText);
                const data = JSON.parse(rawText);

                console.log('verifyOtpForm - Parsed Response:', data);
                if (!response.ok) {
                    throw new Error(data.message || 'Verification failed');
                }

                toastr.success('Password updated successfully!');
                showLogin();
            } catch (error) {
                toastr.error(error.message || 'Error verifying OTP');
                console.error('verifyOtpForm - Error:', error);
                hideLoadingOverlay();
            }
        });
    </script>
</body>
</html>