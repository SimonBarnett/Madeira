<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clubmadeira.io | Partner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .header { height: 150px; background-color: #f4f4f4; margin-bottom: 25px; overflow: hidden; position: relative; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .main-container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; }
        .menu-container { flex: 1; max-width: 300px; }
        .content-container { flex: 2; }
        .menu { margin-bottom: 20px; text-align: left; }
        .menu button { padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; text-align: left; width: 100%; margin-bottom: 5px; display: block; }
        .menu button:hover { background-color: #0056b3; }
        .menu .btn-admin { background-color: #dc3545; }
        .menu .btn-admin:hover { background-color: #c82333; }
        .sub-menu { display: none; margin-left: 20px; }
        .sub-menu button { background-color: #17a2b8; }
        .sub-menu button:hover { background-color: #138496; }
        .section { display: none; }
        .active { display: block; }
        .settings-form { display: flex; flex-direction: column; gap: 10px; max-width: 600px; }
        .settings-form label { font-weight: bold; }
        .settings-form input, .settings-form textarea { padding: 5px; }
        .settings-form button { padding: 10px; background-color: #007BFF; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .settings-form button:hover { background-color: #0056b3; }
        #toast-container > .toast-success { background-color: #28a745; border-color: #218838; }
        #toast-container > .toast-error { background-color: #dc3545; border-color: #c82333; }
        .password-container { position: relative; display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; }
        .password-container input { width: 150px; padding-right: 30px; }
        .password-toggle { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .hidden { display: none; }
        tr.clickable:hover { background-color: #f5f5f5; cursor: pointer; }
        #siteRequestsTable button { padding: 5px 10px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        #siteRequestsTable button:hover { background-color: #0056b3; }
        .site-request-detail { max-width: 600px; }
        .site-request-detail label { font-weight: bold; display: block; margin-top: 10px; }
        .site-request-detail p { margin: 5px 0; }
        .site-request-detail img { max-width: 100px; margin: 5px; vertical-align: middle; }
        .site-request-detail .page-section, .site-request-detail .email-section { margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 4px; width: 80%; max-width: 400px; }
        .modal-content label { font-weight: bold; display: block; margin-bottom: 5px; }
        .modal-content input { width: 100%; padding: 5px; margin-bottom: 10px; }
        .modal-content button { width: 100%; }
        .close { float: right; font-size: 20px; cursor: pointer; }
        #documentation-content { padding: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content" id="brandingContent">
            <!-- Branding content will be loaded here -->
        </div>
    </div>
    <div class="main-container">
        <div class="menu-container">
            <div class="menu" id="menu">
                <input type="text" id="userId" style="display: none;">
                <button onclick="showSection('my-account')">My Account</button>
                <button class="btn-admin" onclick="window.location.href='/admin'">Back to Admin</button>
                <button onclick="logout()" style="background-color: #dc3545;">Log Off</button>
            </div>
        </div>
        <div class="content-container">
            <div id="welcome" class="section active">
                <h2>Welcome to Your Partner Dashboard</h2>
                <p>This dashboard is designed for partners to manage merchant integrations with clubmadeira.io. Use the "My Account" section to update your contact details or change your password. If you have admin privileges, you can return to the admin panel using the "Back to Admin" button.</p>
            </div>
            <div id="my-account" class="section">
                <h2>My Account</h2>
                <div class="settings-form">
                    <label for="contactName">Contact Name:</label>
                    <input type="text" id="contactName" placeholder="Enter contact name">
                    <label for="websiteUrl">Website URL:</label>
                    <input type="url" id="websiteUrl" placeholder="Enter website URL">
                    <label for="emailAddress">Email Address:</label>
                    <input type="email" id="emailAddress" placeholder="Enter email address">
                    <label for="phoneNumber">Phone Number:</label>
                    <input type="tel" id="phoneNumber" placeholder="Enter phone number">
                    <button onclick="saveSettings()">Save Settings</button>
                    <h3>Change Password</h3>
                    <div class="password-container">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('currentPassword')"></i>
                    </div>
                    <div class="password-container">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('newPassword')"></i>
                    </div>
                    <div class="password-container">
                        <label for="confirmPassword">Confirm New Password:</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        <i class="fas fa-eye password-toggle" onclick="togglePassword('confirmPassword')"></i>
                    </div>
                    <button onclick="savePassword()">Change Password</button>
                </div>
            </div>
            <div id="my-products" class="section">
                <h2>My Products</h2>
                <p>These are the products from your parts feed.</p>
                <table id="productTable">
                    <thead>
                        <tr><th class="hidden">ID</th><th>Category</th><th>Title</th><th>URL</th><th>Price</th><th>Original</th><th>Image</th><th>QTY</th></tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
            <div id="wix-keys" class="section">
                <h2>Wix Keys</h2>
                <p>Your Wix Client ID is used to integrate your merchant account with Wix services. Ensure it matches the key provided in your Wix developer dashboard.</p>
                <div class="settings-form">
                    <label for="wixClientId">Wix Client ID:</label>
                    <input type="text" id="wixClientId" placeholder="Enter Wix Client ID">
                    <button onclick="saveWixClientId()">Save Wix Client ID</button>
                </div>
            </div>
            <div id="site-requests" class="section">
                <h2>Site Requests</h2>
                <p>View and manage site requests from merchants and communities. Click a row to see details.</p>
                <table id="siteRequestsTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Received At</th>
                            <th>Contact Name</th>
                            <th>Email</th>
                            <th>Organisation</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="siteRequestsList"></tbody>
                </table>
            </div>
            <div id="site-request-detail" class="section">
                <h2>Site Request Details</h2>
                <div class="settings-form">
                    <button onclick="showSection('site-requests')">Back to Site Requests</button>
                    <div id="siteRequestContent"></div>
                </div>
            </div>
            <div id="documentation" class="section">
                <h2>Documentation</h2>
                <div id="documentation-content"></div>
            </div>
            <!-- Modal for API Key -->
            <div id="apiKeyModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeApiKeyModal()">Ã—</span>
                    <h3>Enter API Key</h3>
                    <label for="merchantWixClientId">Wix Client ID:</label>
                    <input type="text" id="merchantWixClientId" placeholder="Enter Wix Client ID">
                    <button onclick="saveMerchantWixClientId()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        const apiUrl = 'https://clubmadeira.io';
        let userPermissions = [];
        let currentUserId = '';

        function decodeJWT(token) {
            if (!token || typeof token !== 'string') {
                console.error('Invalid token: Token is not a string or is undefined/null');
                return null;
            }
            const parts = token.split('.');
            if (parts.length !== 3) {
                console.error('Invalid token format: Must have 3 parts (header.payload.signature)');
                return null;
            }
            try {
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding JWT:', error.message);
                return null;
            }
        }

        window.onload = function() {
            const token = localStorage.getItem('authToken');
            const userId = localStorage.getItem('userId');
            if (!token) {
                window.location.href = '/';
                return;
            }
            const decoded = decodeJWT(token);
            if (!decoded) {
                window.location.href = '/';
                return;
            }
            userPermissions = decoded.permissions || [];
            if (!userPermissions.includes('admin') && !userPermissions.includes('wixpro')) {
                toastr.error('Permission denied: Partner permission required');
                window.location.href = '/';
                return;
            }
            if (userId) {
                document.getElementById('userId').value = userId;
            }
            updateMenu();
            loadBranding();
        };

        toastr.options = { closeButton: true, progressBar: true, positionClass: 'toast-top-right', timeOut: 5000, showMethod: 'slideDown', hideMethod: 'slideUp' };

        function updateMenu() {
            const menu = document.getElementById('menu');
            const staticButtons = menu.querySelectorAll('button');
            staticButtons.forEach(btn => btn.remove());

            if (userPermissions.includes('wixpro') && userPermissions.includes('validated')) {
                const siteRequestsButton = document.createElement('button');
                siteRequestsButton.textContent = 'Site Requests';
                siteRequestsButton.onclick = () => showSection('site-requests');
                menu.appendChild(siteRequestsButton);
            }

            if (userPermissions.includes('merchant')) {
                const productsButton = document.createElement('button');
                productsButton.textContent = 'My Products';
                productsButton.onclick = () => showSection('my-products');
                menu.appendChild(productsButton);
            }

            if (userPermissions.includes('merchant')) {
                const wixKeysButton = document.createElement('button');
                wixKeysButton.textContent = 'Wix Keys';
                wixKeysButton.onclick = () => showSection('wix-keys');
                menu.appendChild(wixKeysButton);
            }

            const myAccountButton = document.createElement('button');
            myAccountButton.textContent = 'My Account';
            myAccountButton.onclick = () => showSection('my-account');
            menu.appendChild(myAccountButton);

            // Add Documentation button with sub-menu
            const docButton = document.createElement('button');
            docButton.textContent = 'Documentation';
            docButton.onclick = toggleDocumentation;
            menu.appendChild(docButton);

            const subMenu = document.createElement('div');
            subMenu.className = 'sub-menu';
            subMenu.id = 'documentation-sub-menu';

            const veloButton = document.createElement('button');
            veloButton.textContent = 'Velo Docs';
            veloButton.onclick = () => showDocumentation('velo');
            subMenu.appendChild(veloButton);

            const flaskButton = document.createElement('button');
            flaskButton.textContent = 'Flask Docs';
            flaskButton.onclick = () => showDocumentation('flask');
            subMenu.appendChild(flaskButton);

            menu.appendChild(subMenu);

            if (userPermissions.includes('admin')) {
                const backButton = document.createElement('button');
                backButton.textContent = 'Back to Admin';
                backButton.className = 'btn-admin';
                backButton.onclick = () => window.location.href = '/admin';
                menu.appendChild(backButton);
            }

            const logOffButton = document.createElement('button');
            logOffButton.textContent = 'Log Off';
            logOffButton.style.backgroundColor = '#dc3545';
            logOffButton.onclick = logout;
            menu.appendChild(logOffButton);
        }

        async function loadBranding() {
            try {
                const response = await authenticatedFetch(`${apiUrl}/branding`);
                if (!response.ok) throw new Error(`Failed to fetch branding: ${response.status}`);
                const data = await response.json();
                document.getElementById('brandingContent').innerHTML = data.content || '<h1>Partner Dashboard</h1>';
            } catch (error) {
                toastr.error(`Error loading branding: ${error.message}`);
                document.getElementById('brandingContent').innerHTML = '<h1>Partner Dashboard</h1>';
            }
        }

        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('authToken');
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const response = await fetch(url, options);
            if (response.status === 401) {
                toastr.error('Session expired. Please log in again.');
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                window.location.href = '/';
            }
            return response;
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            if (section === 'my-account') loadSettings();
            else if (section === 'my-products') loadProducts();
            else if (section === 'wix-keys') loadWixClientId();
            else if (section === 'site-requests') loadSiteRequests();
        }

        function toggleDocumentation() {
            const subMenu = document.getElementById('documentation-sub-menu');
            const isVisible = subMenu.style.display === 'block';
            subMenu.style.display = isVisible ? 'none' : 'block';
            showSection('documentation');
            document.getElementById('documentation-content').innerHTML = `
                <p>This section provides documentation for integrating with clubmadeira.io. Select a specific topic below:</p>
                <ul>
                    <li><strong>Velo Docs</strong>: Information on using Velo for Wix integrations.</li>
                    <li><strong>Flask Docs</strong>: Details on the Flask backend implementation.</li>
                </ul>
            `;
        }

        async function showDocumentation(type) {
            showSection('documentation');
            const contentDiv = document.getElementById('documentation-content');
            let url;
            if (type === 'velo') {
                url = `${apiUrl}/render-github-md/SimonBarnett/Madeira/main/velo.md`;
            } else if (type === 'flask') {
                url = `${apiUrl}/render-github-md/SimonBarnett/Madeira/main/flask.md`;
            }
            try {
                const response = await authenticatedFetch(url);
                if (!response.ok) throw new Error(`Failed to load ${type} documentation: ${response.status}`);
                const html = await response.text();
                contentDiv.innerHTML = html;
            } catch (error) {
                toastr.error(`Error loading ${type} documentation: ${error.message}`);
                contentDiv.innerHTML = `<p>Failed to load ${type} documentation.</p>`;
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            toastr.success('Logged out successfully');
            window.location.href = '/';
        }

        async function loadSettings() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/user`);
                if (!response.ok) throw new Error(`Failed to fetch settings: ${response.status}`);
                const data = await response.json();
                document.getElementById('contactName').value = data.contact_name || '';
                document.getElementById('websiteUrl').value = data.website_url || '';
                document.getElementById('emailAddress').value = data.email_address || '';
                document.getElementById('phoneNumber').value = data.phone_number || '';
            } catch (error) {
                toastr.error(`Error loading settings: ${error.message}`);
            }
        }

        async function saveSettings() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            const settings = {
                contact_name: document.getElementById('contactName').value.trim(),
                website_url: document.getElementById('websiteUrl').value.trim(),
                email_address: document.getElementById('emailAddress').value.trim(),
                phone_number: document.getElementById('phoneNumber').value.trim()
            };
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/user`, { method: 'PUT', body: JSON.stringify(settings) });
                if (!response.ok) throw new Error(`Failed to save settings: ${response.status}`);
                toastr.success('Settings saved successfully');
            } catch (error) {
                toastr.error(`Error saving settings: ${error.message}`);
            }
        }

        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            const icon = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function savePassword() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            const passwordRegex = /^(?=.*\d).{8,}$/;
            if (!passwordRegex.test(newPassword)) {
                toastr.error('New password must be at least 8 characters long and include numbers');
                return;
            }
            if (newPassword !== confirmPassword) {
                toastr.error('New password and confirmation do not match');
                return;
            }

            const passwordData = { currentPassword, newPassword };
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/password`, {
                    method: 'POST',
                    body: JSON.stringify(passwordData)
                });
                if (!response.ok) throw new Error(`Failed to change password: ${response.status}`);
                toastr.success('Password changed successfully');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                toastr.error(`Error changing password: ${error.message}`);
            }
        }

        async function loadProducts() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/products`);
                if (!response.ok) throw new Error(`Failed to fetch products: ${response.status}`);
                const data = await response.json();
                const tbody = document.getElementById('productList');
                tbody.innerHTML = '';
                data.products.forEach(product => tbody.appendChild(createProductRow(product)));
            } catch (error) {
                toastr.error(`Error loading products: ${error.message}`);
            }
        }

        function createProductRow(product) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="hidden">${product.id}</td>
                <td>${product.category}</td>
                <td>${product.title}</td>
                <td><a href="${product.product_url}" target="_blank">Link</a></td>
                <td>${product.current_price}</td>
                <td>${product.original_price}</td>
                <td><img src="${product.image_url}" width="50"></td>
                <td>${product.qty}</td>
            `;
            return tr;
        }

        async function loadWixClientId() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/user`);
                if (!response.ok) throw new Error(`Failed to fetch Wix Client ID: ${response.status}`);
                const data = await response.json();
                document.getElementById('wixClientId').value = data.wixClientId || '';
            } catch (error) {
                toastr.error(`Error loading Wix Client ID: ${error.message}`);
            }
        }

        async function saveWixClientId() {
            const userId = document.getElementById('userId').value;
            if (!userId) { toastr.error('User ID not found in session'); return; }
            const wixClientId = document.getElementById('wixClientId').value.trim();
            try {
                const response = await authenticatedFetch(`${apiUrl}/${userId}/user`, {
                    method: 'PATCH',
                    body: JSON.stringify({ wixClientId })
                });
                if (!response.ok) throw new Error(`Failed to save Wix Client ID: ${response.status}`);
                toastr.success('Wix Client ID saved successfully');
            } catch (error) {
                toastr.error(`Error saving Wix Client ID: ${error.message}`);
            }
        }

        async function loadSiteRequests() {
            try {
                const url = `${apiUrl}/siterequests`;
                const response = await authenticatedFetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch site requests: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                const tbody = document.getElementById('siteRequestsList');
                tbody.innerHTML = '';
                if (data.siterequests && data.siterequests.length > 0) {
                    data.siterequests.forEach(request => {
                        const row = createSiteRequestRow(request);
                        row.classList.add('clickable');
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">No site requests found.</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error(`Error loading site requests: ${error.message}`);
                const tbody = document.getElementById('siteRequestsList');
                tbody.innerHTML = `<tr><td colspan="6">Error loading site requests: ${error.message}</td></tr>`;
            }
        }

        function createSiteRequestRow(request) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${request.type || ''}</td>
                <td>${request.received_at || ''}</td>
                <td>${request.contact_name || ''}</td>
                <td>${request.email || ''}</td>
                <td>${request.organisation || ''}</td>
                <td>${
                    request.type === 'merchant' 
                        ? `<button onclick="openApiKeyModal('${request.user_id}')">Enter API Key</button>` 
                        : ''
                }</td>
            `;
            tr.dataset.userId = request.user_id;
            tr.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    loadSiteRequestDetail(request.user_id);
                }
            });
            return tr;
        }

        async function loadSiteRequestDetail(userId) {
            try {
                const url = `${apiUrl}/${userId}/siterequest`;
                const response = await authenticatedFetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch site request details: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                const content = document.getElementById('siteRequestContent');
                if (data.status === 'success' && Object.keys(data.site_request).length > 0) {
                    const siteRequest = data.site_request;
                    content.innerHTML = `
                        <label>Community Name:</label>
                        <p>${siteRequest.communityName || ''}</p>
                        <label>About Our Community:</label>
                        <p>${siteRequest.aboutCommunity || ''}</p>
                        <label>Community Logos:</label>
                        <div>${(siteRequest.communityLogos || []).map(logo => `<img src="${logo}" alt="Community Logo">`).join(' ')}</div>
                        <label>Color Preferences:</label>
                        <p>${siteRequest.colorPrefs || ''}</p>
                        <label>Styling Details:</label>
                        <p>${siteRequest.stylingDetails || ''}</p>
                        <label>Preferred Domain Name:</label>
                        <p>${siteRequest.preferredDomain || 'mycommunity.org'}</p>
                        <label>Email Addresses to Set Up:</label>
                        <div>${(siteRequest.emails || []).map(email => `<div class="email-section">${email}@${siteRequest.preferredDomain || 'mycommunity.org'}</div>`).join('')}</div>
                        <label>Requested Pages:</label>
                        <div>${(siteRequest.pages || []).map(page => `
                            <div class="page-section">
                                <label>Page Name:</label>
                                <p>${page.name || ''}</p>
                                <label>Page Content:</label>
                                <p>${page.content || ''}</p>
                                <label>Additional Images:</label>
                                <div>${(page.images || []).map(img => `<img src="${img}" alt="Page Image">`).join(' ')}</div>
                            </div>
                        `).join('')}</div>
                        <label>Wix Widgets:</label>
                        <div>${(siteRequest.widgets || []).map(widget => `<p>${widget}</p>`).join('')}</div>
                    `;
                    currentUserId = userId;
                } else {
                    content.innerHTML = '<p>No details available for this site request.</p>';
                }
                showSection('site-request-detail');
            } catch (error) {
                toastr.error(`Error loading site request details: ${error.message}`);
                document.getElementById('siteRequestContent').innerHTML = `<p>Error: ${error.message}</p>`;
                showSection('site-request-detail');
            }
        }

        function openApiKeyModal(userId) {
            currentUserId = userId;
            document.getElementById('merchantWixClientId').value = '';
            document.getElementById('apiKeyModal').style.display = 'block';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        async function saveMerchantWixClientId() {
            const wixClientId = document.getElementById('merchantWixClientId').value.trim();
            if (!wixClientId) {
                toastr.error('Wix Client ID cannot be empty');
                return;
            }
            if (!currentUserId) {
                toastr.error('User ID is missing. Please try again.');
                return;
            }
            try {
                const response = await authenticatedFetch(`${apiUrl}/${currentUserId}/user`, {
                    method: 'PATCH',
                    body: JSON.stringify({ wixClientId })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save Wix Client ID: ${response.status} - ${errorText}`);
                }
                toastr.success('Wix Client ID saved successfully');
                closeApiKeyModal();
            } catch (error) {
                toastr.error(`Error saving Wix Client ID: ${error.message}`);
            }
        }
    </script>
</body>
</html>