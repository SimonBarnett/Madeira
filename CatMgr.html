<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .menu { margin-bottom: 20px; }
        .menu a { margin-right: 15px; text-decoration: none; color: #007BFF; }
        .menu a:hover { text-decoration: underline; }
        .section { display: none; }
        .active { display: block; }
        .treeview { max-height: 400px; overflow-y: auto; margin-bottom: 10px; }
        .treeview,
        .treeview ul,
        .treeview li {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .treeview .node { display: flex; align-items: center; }
        .treeview .toggle { cursor: pointer; width: 20px; text-align: center; font-weight: bold; }
        .treeview .subcategories { display: none; padding-left: 20px; }
        .treeview .subcategories.open { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .edit-mode input { width: 90%; }
        .icon { cursor: pointer; margin: 0 5px; }
        .error-star { color: red; font-size: 16px; margin-left: 2px; }
        .short-input { width: 5ch; }
        .settings-form { display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .settings-form label { font-weight: bold; }
        .settings-form input { padding: 5px; }
        .settings-form button { padding: 10px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
        .settings-form button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">        
        <div class="menu">
            <label for="userId">User ID:</label>
            <input type="text" id="userId" placeholder="Enter User ID"><br><br>
            | <a href="#" onclick="showSection('settings'); return false;">User</a>
            | <a href="#" onclick="showSection('categories'); return false;">Categories</a>
            | <a href="#" onclick="showSection('products'); return false;">Products</a>
        </div>

        <div id="categories" class="section">
            <h2>Categories</h2>
            <div class="treeview" id="categoryTree"></div>
        </div>

        <div id="products" class="section">
            <h2>Products <i class="fas fa-plus icon" onclick="addNewProduct()" title="Add New Product"></i></h2>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>URL</th>
                        <th>Price</th>
                        <th>Original</th>
                        <th>Image</th>
                        <th>QTY</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productList"></tbody>
            </table>            
        </div>

        <div id="settings" class="section">
            <h2>User Settings</h2>
            <div class="settings-form">
                <label for="contactName">Contact Name:</label>
                <input type="text" id="contactName" placeholder="Enter contact name">
                <label for="websiteUrl">Website URL:</label>
                <input type="url" id="websiteUrl" placeholder="Enter website URL">
                <label for="emailAddress">Email Address:</label>
                <input type="email" id="emailAddress" placeholder="Enter email address">
                <label for="phoneNumber">Phone Number:</label>
                <input type="tel" id="phoneNumber" placeholder="Enter phone number">
                <button onclick="saveSettings()">Save Settings</button>
            </div>
        </div>

        <div id="response"></div>
    </div>

    <script>
        const apiUrl = 'http://localhost:5000';
        let editingProductId = null;

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            if (section === 'categories') loadCategories();
            else if (section === 'products') loadProducts();
            else if (section === 'settings') loadSettings();
        }

        // Categories Functions
        async function loadCategories() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                document.getElementById('response').innerText = 'Please enter a User ID';
                return;
            }

            try {
                const userResponse = await fetch(`${apiUrl}/${userId}/mycategories`);
                if (!userResponse.ok) throw new Error(`Failed to fetch /${userId}/mycategories: ${userResponse.status}`);
                const userData = await userResponse.json();
                console.log('User Categories:', userData);
                const savedCategories = userData.categories || [];

                const response = await fetch(`${apiUrl}/categories`);
                if (!response.ok) throw new Error(`Failed to fetch /categories: ${response.status}`);
                const data = await response.json();
                console.log('Top-Level Categories:', data);

                const tree = document.getElementById('categoryTree');
                tree.innerHTML = '';
                const ul = document.createElement('ul');
                data.categories.forEach(cat => {
                    ul.appendChild(createTreeNode(cat, savedCategories));
                });
                tree.appendChild(ul);
            } catch (error) {
                console.error('Error in loadCategories:', error);
                document.getElementById('response').innerText = `Error loading categories: ${error.message}`;
            }
        }

        function createTreeNode(category, savedCategories) {
            const li = document.createElement('li');
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'node';

            const toggle = document.createElement('span');
            toggle.className = 'toggle';
            toggle.textContent = '+';
            toggle.onclick = () => toggleSubcategories(category.id, toggle);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = category.id;
            checkbox.checked = savedCategories.includes(category.id.toString());
            checkbox.onchange = () => saveCategories();

            const span = document.createElement('span');
            span.textContent = `${category.name} (${category.id})`;

            nodeDiv.appendChild(toggle);
            nodeDiv.appendChild(checkbox);
            nodeDiv.appendChild(span);
            li.appendChild(nodeDiv);

            const subUl = document.createElement('ul');
            subUl.className = 'subcategories';
            li.appendChild(subUl);

            return li;
        }

        async function toggleSubcategories(parentId, toggle) {
            const li = toggle.closest('li');
            const subUl = li.querySelector('.subcategories');

            if (subUl.classList.contains('open')) {
                subUl.classList.remove('open');
                toggle.textContent = '+';
            } else {
                if (subUl.children.length === 0) {
                    try {
                        const response = await fetch(`${apiUrl}/categories?parent_id=${parentId}`);
                        if (!response.ok) throw new Error(`Failed to fetch subcategories for ${parentId}: ${response.status}`);
                        const data = await response.json();
                        console.log(`Subcategories for ${parentId}:`, data);

                        const userId = document.getElementById('userId').value;
                        const userResponse = await fetch(`${apiUrl}/${userId}/mycategories`);
                        if (!userResponse.ok) throw new Error(`Failed to fetch /${userId}/mycategories: ${userResponse.status}`);
                        const userData = await userResponse.json();
                        console.log('User Categories (sub):', userData);
                        const savedCategories = userData.categories || [];

                        data.categories.forEach(cat => {
                            subUl.appendChild(createTreeNode(cat, savedCategories));
                        });
                    } catch (error) {
                        console.error('Error in toggleSubcategories:', error);
                        document.getElementById('response').innerText = `Error loading subcategories: ${error.message}`;
                        return;
                    }
                }
                subUl.classList.add('open');
                toggle.textContent = '-';
            }
        }

        async function saveCategories() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                document.getElementById('response').innerText = 'Please enter a User ID';
                return;
            }
            const checked = Array.from(document.querySelectorAll('#categoryTree input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            try {
                const response = await fetch(`${apiUrl}/${userId}/mycategories`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories: checked })
                });
                if (!response.ok) throw new Error(`Failed to save categories: ${response.status}`);
                const data = await response.json();
                document.getElementById('response').innerText = 'Categories saved: ' + JSON.stringify(data.categories);
            } catch (error) {
                console.error('Error in saveCategories:', error);
                document.getElementById('response').innerText = `Error saving categories: ${error.message}`;
            }
        }

        // Settings Functions
        async function loadSettings() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                document.getElementById('response').innerText = 'Please enter a User ID';
                return;
            }
            try {
                const response = await fetch(`${apiUrl}/${userId}/user`);
                if (!response.ok) throw new Error(`Failed to fetch /${userId}/user: ${response.status}`);
                const data = await response.json();
                console.log('User Settings:', data);
                document.getElementById('contactName').value = data.contact_name || '';
                document.getElementById('websiteUrl').value = data.website_url || '';
                document.getElementById('emailAddress').value = data.email_address || '';
                document.getElementById('phoneNumber').value = data.phone_number || '';
            } catch (error) {
                console.error('Error in loadSettings:', error);
                document.getElementById('response').innerText = `Error loading settings: ${error.message}`;
            }
        }

        async function saveSettings() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                document.getElementById('response').innerText = 'Please enter a User ID';
                return;
            }
            const settings = {
                contact_name: document.getElementById('contactName').value.trim(),
                website_url: document.getElementById('websiteUrl').value.trim(),
                email_address: document.getElementById('emailAddress').value.trim(),
                phone_number: document.getElementById('phoneNumber').value.trim()
            };
            try {
                const response = await fetch(`${apiUrl}/${userId}/user`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                if (!response.ok) throw new Error(`Failed to save settings: ${response.status}`);
                const data = await response.json();
                document.getElementById('response').innerText = 'Settings saved successfully';
            } catch (error) {
                console.error('Error in saveSettings:', error);
                document.getElementById('response').innerText = `Error saving settings: ${error.message}`;
            }
        }

        // Products Functions
        async function loadProducts() {
            const userId = document.getElementById('userId').value;
            const response = await fetch(`${apiUrl}/${userId}/products`);
            const data = await response.json();
            const tbody = document.getElementById('productList');
            tbody.innerHTML = '';
            data.products.forEach(product => tbody.appendChild(createProductRow(product)));
        }

        function createProductRow(product) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${product.id}</td>
                <td>${product.title}</td>
                <td><a href="${product.product_url}" target="_blank">Link</a></td>
                <td>${product.current_price}</td>
                <td>${product.original_price}</td>
                <td><img src="${product.image_url}" width="50"></td>
                <td>${product.QTY}</td>
                <td>
                    <i class="fas fa-edit icon" onclick="editProduct('${product.id}', this)"></i>
                    <i class="fas fa-trash-alt icon" onclick="deleteProduct('${product.id}')"></i>
                </td>
            `;
            return tr;
        }

        function editProduct(productId, icon) {
            if (editingProductId) return;
            editingProductId = productId;
            const tr = icon.closest('tr');
            const tds = tr.querySelectorAll('td');
            const fields = ['id', 'title', 'product_url', 'current_price', 'original_price', 'image_url', 'QTY'];
            fields.forEach((field, i) => {
                let value = field === 'product_url' ? tds[i].querySelector('a').href :
                            field === 'image_url' ? tds[i].querySelector('img').src : tds[i].textContent;
                const inputClass = (field === 'id' || field === 'current_price' || field === 'original_price' || field === 'QTY') ? 'short-input' : '';
                tds[i].innerHTML = `<input type="text" class="${inputClass}" value="${value}" required>`;
            });
            tds[7].innerHTML = `
                <i class="fas fa-save icon" onclick="saveProduct('${productId}', this)"></i>
                <i class="fas fa-times icon" onclick="cancelEdit()"></i>
            `;
        }

        async function saveProduct(productId, icon) {
            const userId = document.getElementById('userId').value;
            const tr = icon.closest('tr');
            const inputs = tr.querySelectorAll('input');
            const product = {
                id: inputs[0].value.trim(),
                title: inputs[1].value.trim(),
                product_url: inputs[2].value.trim(),
                current_price: parseFloat(inputs[3].value),
                original_price: parseFloat(inputs[4].value),
                image_url: inputs[5].value.trim(),
                QTY: parseInt(inputs[6].value)
            };
            const response = await fetch(`${apiUrl}/${userId}/products`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: [product] })
            });
            editingProductId = null;
            loadProducts();
        }

        function cancelEdit() {
            editingProductId = null;
            loadProducts();
        }

        async function addNewProduct() {
            const tbody = document.getElementById('productList');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="short-input" required></td>
                <td><input type="text" required></td>
                <td><input type="text" required></td>
                <td><input type="text" class="short-input" required></td>
                <td><input type="text" class="short-input" required></td>
                <td><input type="text" required></td>
                <td><input type="text" class="short-input" required></td>
                <td>
                    <i class="fas fa-save icon" onclick="saveNewProduct(this)"></i>
                    <i class="fas fa-times icon" onclick="cancelEdit()"></i>
                </td>
            `;
            tbody.appendChild(tr);
            await saveNewProduct(tr.querySelector('.fas.fa-save'));
        }

        async function saveNewProduct(icon) {
            const userId = document.getElementById('userId').value;
            const tr = icon.closest('tr');
            const inputs = tr.querySelectorAll('input');
            const product = {
                id: inputs[0].value.trim(),
                title: inputs[1].value.trim(),
                product_url: inputs[2].value.trim(),
                current_price: parseFloat(inputs[3].value),
                original_price: parseFloat(inputs[4].value),
                image_url: inputs[5].value.trim(),
                QTY: parseInt(inputs[6].value)
            };
            const response = await fetch(`${apiUrl}/${userId}/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product })
            });
            if (response.ok) loadProducts();
        }

        async function deleteProduct(productId) {
            const userId = document.getElementById('userId').value;
            const response = await fetch(`${apiUrl}/${userId}/products?product_id=${productId}`, {
                method: 'DELETE'
            });
            loadProducts();
        }
    </script>
</body>
</html>